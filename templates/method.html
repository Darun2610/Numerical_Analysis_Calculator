<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ method_name.replace('_', ' ').title() }} - Numerical Methods Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .method-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .form-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .result-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .iteration-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .plot-container {
            text-align: center;
            margin: 1rem 0;
        }
        .plot-container img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-calculator me-2"></i>
                Numerical Methods Calculator
            </a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="method-container">
            <div class="text-center mb-4">
                <h1 class="display-5">
                    <i class="fas fa-calculator me-3"></i>
                    {{ method_name.replace('_', ' ').title() }}
                </h1>
            </div>

            <!-- Input Form -->
            <div class="form-section">
                <h3>Input Parameters</h3>
                
                <!-- Help Section -->
                <div class="alert alert-info mb-3">
                    <h5><i class="fas fa-info-circle me-2"></i>Supported Functions</h5>
                    <p class="mb-2"><strong>Basic Operations:</strong> +, -, *, /, ** (power), ^ (power)</p>
                    <p class="mb-2"><strong>Trigonometric:</strong> sin(x), cos(x), tan(x), asin(x), acos(x), atan(x)</p>
                    <p class="mb-2"><strong>Hyperbolic:</strong> sinh(x), cosh(x), tanh(x)</p>
                    <p class="mb-2"><strong>Exponential/Logarithmic:</strong> exp(x), log(x), log10(x)</p>
                    <p class="mb-2"><strong>Other:</strong> sqrt(x), abs(x), pi, e</p>
                    <p class="mb-0"><strong>Examples:</strong> x**2 - 4, x^2 - 4, sin(x), exp(x), x**3 - 2*x</p>
                </div>
                
                <form id="method-form">
                    <div id="form-fields">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            Calculate
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="loadExample()">
                            Load Example
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Calculating results...</p>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="error-message" style="display: none;"></div>

            <!-- Results -->
            <div class="result-section" id="results" style="display: none;">
                <h3>Results</h3>
                
                <!-- Final Result -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Final Result</h5>
                                <div id="final-result"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Method Information</h5>
                                <div id="method-info"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Iteration Table -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Step-by-Step Iterations</h5>
                        <div class="iteration-table">
                            <div id="iteration-table"></div>
                        </div>
                    </div>
                </div>

                <!-- Plot -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Visualization</h5>
                        <div class="plot-container" id="plot-container">
                            <!-- Plot will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const methodName = '{{ method_name }}';
        
        // Method configurations
        const methodConfigs = {
            'bisection': {
                title: 'Bisection Method',
                fields: [
                    { name: 'function', label: 'Function f(x)', type: 'text', placeholder: 'e.g., x**2 - 4, x^2 - 4, sin(x), exp(x)', required: true },
                    { name: 'a', label: 'Lower bound (a)', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'b', label: 'Upper bound (b)', type: 'number', placeholder: 'e.g., 3', required: true },
                    { name: 'tolerance', label: 'Tolerance', type: 'number', placeholder: 'e.g., 0.0001', value: '0.0001', required: true },
                    { name: 'max_iterations', label: 'Max Iterations', type: 'number', placeholder: 'e.g., 100', value: '100', required: true }
                ],
                example: {
                    function: 'x^2 - 4',
                    a: '0',
                    b: '3',
                    tolerance: '0.0001',
                    max_iterations: '100'
                },
                apiEndpoint: '/api/bisection'
            },
            'newton_raphson': {
                title: 'Newton-Raphson Method',
                fields: [
                    { name: 'function', label: 'Function f(x)', type: 'text', placeholder: 'e.g., x**2 - 4, x^2 - 4, sin(x), exp(x)', required: true },
                    { name: 'derivative', label: 'Derivative f\'(x)', type: 'text', placeholder: 'e.g., 2*x, 2*x, cos(x), exp(x)', required: true },
                    { name: 'x0', label: 'Initial guess (x₀)', type: 'number', placeholder: 'e.g., 2', required: true },
                    { name: 'tolerance', label: 'Tolerance', type: 'number', placeholder: 'e.g., 0.0001', value: '0.0001', required: true },
                    { name: 'max_iterations', label: 'Max Iterations', type: 'number', placeholder: 'e.g., 100', value: '100', required: true }
                ],
                example: {
                    function: 'x^2 - 4',
                    derivative: '2*x',
                    x0: '2',
                    tolerance: '0.0001',
                    max_iterations: '100'
                },
                apiEndpoint: '/api/newton_raphson'
            },
            'regula_falsi': {
                title: 'Regula Falsi Method',
                fields: [
                    { name: 'function', label: 'Function f(x)', type: 'text', placeholder: 'e.g., x**2 - 4, x^2 - 4, sin(x), exp(x)', required: true },
                    { name: 'a', label: 'Lower bound (a)', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'b', label: 'Upper bound (b)', type: 'number', placeholder: 'e.g., 3', required: true },
                    { name: 'tolerance', label: 'Tolerance', type: 'number', placeholder: 'e.g., 0.0001', value: '0.0001', required: true },
                    { name: 'max_iterations', label: 'Max Iterations', type: 'number', placeholder: 'e.g., 100', value: '100', required: true }
                ],
                example: {
                    function: 'x^2 - 4',
                    a: '0',
                    b: '3',
                    tolerance: '0.0001',
                    max_iterations: '100'
                },
                apiEndpoint: '/api/regula_falsi'
            },
            'secant': {
                title: 'Secant Method',
                fields: [
                    { name: 'function', label: 'Function f(x)', type: 'text', placeholder: 'e.g., x**2 - 4, x^2 - 4, sin(x), exp(x)', required: true },
                    { name: 'x0', label: 'First initial guess (x₀)', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'x1', label: 'Second initial guess (x₁)', type: 'number', placeholder: 'e.g., 3', required: true },
                    { name: 'tolerance', label: 'Tolerance', type: 'number', placeholder: 'e.g., 0.0001', value: '0.0001', required: true },
                    { name: 'max_iterations', label: 'Max Iterations', type: 'number', placeholder: 'e.g., 100', value: '100', required: true }
                ],
                example: {
                    function: 'x^2 - 4',
                    x0: '0',
                    x1: '3',
                    tolerance: '0.0001',
                    max_iterations: '100'
                },
                apiEndpoint: '/api/secant'
            },
            'gauss_jacobi': {
                title: 'Gauss-Jacobi Method',
                fields: [
                    { name: 'matrix', label: 'Coefficient Matrix (JSON)', type: 'text', placeholder: 'e.g., [[4,1,1],[1,4,1],[1,1,4]]', required: true },
                    { name: 'b_vector', label: 'Right-hand side vector (JSON)', type: 'text', placeholder: 'e.g., [1,2,3]', required: true },
                    { name: 'tolerance', label: 'Tolerance', type: 'number', placeholder: 'e.g., 0.0001', value: '0.0001', required: true },
                    { name: 'max_iterations', label: 'Max Iterations', type: 'number', placeholder: 'e.g., 100', value: '100', required: true }
                ],
                example: {
                    matrix: '[[4,1,1],[1,4,1],[1,1,4]]',
                    b_vector: '[1,2,3]',
                    tolerance: '0.0001',
                    max_iterations: '100'
                },
                apiEndpoint: '/api/gauss_jacobi'
            },
            'gauss_seidel': {
                title: 'Gauss-Seidel Method',
                fields: [
                    { name: 'matrix', label: 'Coefficient Matrix (JSON)', type: 'text', placeholder: 'e.g., [[4,1,1],[1,4,1],[1,1,4]]', required: true },
                    { name: 'b_vector', label: 'Right-hand side vector (JSON)', type: 'text', placeholder: 'e.g., [1,2,3]', required: true },
                    { name: 'tolerance', label: 'Tolerance', type: 'number', placeholder: 'e.g., 0.0001', value: '0.0001', required: true },
                    { name: 'max_iterations', label: 'Max Iterations', type: 'number', placeholder: 'e.g., 100', value: '100', required: true }
                ],
                example: {
                    matrix: '[[4,1,1],[1,4,1],[1,1,4]]',
                    b_vector: '[1,2,3]',
                    tolerance: '0.0001',
                    max_iterations: '100'
                },
                apiEndpoint: '/api/gauss_seidel'
            },
            'thomas_algorithm': {
                title: 'Thomas Algorithm',
                fields: [
                    { name: 'a', label: 'Subdiagonal (JSON)', type: 'text', placeholder: 'e.g., [0,1,1]', required: true },
                    { name: 'b', label: 'Main diagonal (JSON)', type: 'text', placeholder: 'e.g., [2,2,2]', required: true },
                    { name: 'c', label: 'Superdiagonal (JSON)', type: 'text', placeholder: 'e.g., [1,1,0]', required: true },
                    { name: 'd', label: 'Right-hand side (JSON)', type: 'text', placeholder: 'e.g., [1,2,3]', required: true }
                ],
                example: {
                    a: '[0,1,1]',
                    b: '[2,2,2]',
                    c: '[1,1,0]',
                    d: '[1,2,3]'
                },
                apiEndpoint: '/api/thomas_algorithm'
            },
            'newton_interpolation': {
                title: 'Newton Interpolation',
                fields: [
                    { name: 'x_points', label: 'X points (JSON)', type: 'text', placeholder: 'e.g., [1,2,4]', required: true },
                    { name: 'y_points', label: 'Y points (JSON)', type: 'text', placeholder: 'e.g., [2,4,8]', required: true },
                    { name: 'x_eval', label: 'X value to interpolate', type: 'number', placeholder: 'e.g., 3', required: true }
                ],
                example: {
                    x_points: '[1,2,4]',
                    y_points: '[2,4,8]',
                    x_eval: '3'
                },
                apiEndpoint: '/api/newton_interpolation'
            },
            'lagrange_interpolation': {
                title: 'Lagrange Interpolation',
                fields: [
                    { name: 'x_points', label: 'X points (JSON)', type: 'text', placeholder: 'e.g., [1,2,4]', required: true },
                    { name: 'y_points', label: 'Y points (JSON)', type: 'text', placeholder: 'e.g., [2,4,8]', required: true },
                    { name: 'x_eval', label: 'X value to interpolate', type: 'number', placeholder: 'e.g., 3', required: true }
                ],
                example: {
                    x_points: '[1,2,4]',
                    y_points: '[2,4,8]',
                    x_eval: '3'
                },
                apiEndpoint: '/api/lagrange_interpolation'
            },
            'trapezoidal': {
                title: 'Trapezoidal Rule',
                fields: [
                    { name: 'function', label: 'Function f(x)', type: 'text', placeholder: 'e.g., x**2, sin(x), exp(x)', required: true },
                    { name: 'a', label: 'Lower bound (a)', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'b', label: 'Upper bound (b)', type: 'number', placeholder: 'e.g., 1', required: true },
                    { name: 'n', label: 'Number of intervals', type: 'number', placeholder: 'e.g., 10', value: '10', required: true }
                ],
                example: {
                    function: 'x**2',
                    a: '0',
                    b: '1',
                    n: '10'
                },
                apiEndpoint: '/api/trapezoidal'
            },
            'simpson': {
                title: 'Simpson\'s Rule',
                fields: [
                    { name: 'function', label: 'Function f(x)', type: 'text', placeholder: 'e.g., x**2, sin(x), exp(x)', required: true },
                    { name: 'a', label: 'Lower bound (a)', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'b', label: 'Upper bound (b)', type: 'number', placeholder: 'e.g., 1', required: true },
                    { name: 'n', label: 'Number of intervals (even)', type: 'number', placeholder: 'e.g., 10', value: '10', required: true }
                ],
                example: {
                    function: 'x**2',
                    a: '0',
                    b: '1',
                    n: '10'
                },
                apiEndpoint: '/api/simpson'
            },
            'midpoint': {
                title: 'Midpoint Rule',
                fields: [
                    { name: 'function', label: 'Function f(x)', type: 'text', placeholder: 'e.g., x**2, sin(x), exp(x)', required: true },
                    { name: 'a', label: 'Lower bound (a)', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'b', label: 'Upper bound (b)', type: 'number', placeholder: 'e.g., 1', required: true },
                    { name: 'n', label: 'Number of intervals', type: 'number', placeholder: 'e.g., 10', value: '10', required: true }
                ],
                example: {
                    function: 'x**2',
                    a: '0',
                    b: '1',
                    n: '10'
                },
                apiEndpoint: '/api/midpoint'
            },
            'trapezoidal_tabular': {
                title: 'Trapezoidal Rule (Tabular Data)',
                fields: [
                    { name: 'x_points', label: 'X Points (comma-separated)', type: 'text', placeholder: 'e.g., 0,1,2,3,4', required: true },
                    { name: 'y_points', label: 'Y Points (comma-separated)', type: 'text', placeholder: 'e.g., 1,2,4,8,16', required: true }
                ],
                example: {
                    x_points: '0,1,2,3,4',
                    y_points: '1,2,4,8,16'
                },
                apiEndpoint: '/api/trapezoidal_tabular'
            },
            'simpson_tabular': {
                title: 'Simpson\'s Rule (Tabular Data)',
                fields: [
                    { name: 'x_points', label: 'X Points (comma-separated)', type: 'text', placeholder: 'e.g., 0,1,2,3,4', required: true },
                    { name: 'y_points', label: 'Y Points (comma-separated)', type: 'text', placeholder: 'e.g., 1,2,4,8,16', required: true }
                ],
                example: {
                    x_points: '0,1,2,3,4',
                    y_points: '1,2,4,8,16'
                },
                apiEndpoint: '/api/simpson_tabular'
            },
            'midpoint_tabular': {
                title: 'Midpoint Rule (Tabular Data)',
                fields: [
                    { name: 'x_points', label: 'X Points (comma-separated)', type: 'text', placeholder: 'e.g., 0,1,2,3,4', required: true },
                    { name: 'y_points', label: 'Y Points (comma-separated)', type: 'text', placeholder: 'e.g., 1,2,4,8,16', required: true }
                ],
                example: {
                    x_points: '0,1,2,3,4',
                    y_points: '1,2,4,8,16'
                },
                apiEndpoint: '/api/midpoint_tabular'
            },
            'euler': {
                title: 'Euler Method',
                fields: [
                    { name: 'function', label: 'Differential equation dy/dx = f(x,y)', type: 'text', placeholder: 'e.g., x + y, x**2 + y**2', required: true },
                    { name: 'x0', label: 'Initial x value', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'y0', label: 'Initial y value', type: 'number', placeholder: 'e.g., 1', required: true },
                    { name: 'h', label: 'Step size', type: 'number', placeholder: 'e.g., 0.1', value: '0.1', required: true },
                    { name: 'n', label: 'Number of steps', type: 'number', placeholder: 'e.g., 10', value: '10', required: true }
                ],
                example: {
                    function: 'x + y',
                    x0: '0',
                    y0: '1',
                    h: '0.1',
                    n: '10'
                },
                apiEndpoint: '/api/euler'
            },
            'modified_euler': {
                title: 'Modified Euler Method',
                fields: [
                    { name: 'function', label: 'Differential equation dy/dx = f(x,y)', type: 'text', placeholder: 'e.g., x + y, x**2 + y**2', required: true },
                    { name: 'x0', label: 'Initial x value', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'y0', label: 'Initial y value', type: 'number', placeholder: 'e.g., 1', required: true },
                    { name: 'h', label: 'Step size', type: 'number', placeholder: 'e.g., 0.1', value: '0.1', required: true },
                    { name: 'n', label: 'Number of steps', type: 'number', placeholder: 'e.g., 10', value: '10', required: true }
                ],
                example: {
                    function: 'x + y',
                    x0: '0',
                    y0: '1',
                    h: '0.1',
                    n: '10'
                },
                apiEndpoint: '/api/modified_euler'
            },
            'rk2': {
                title: 'RK2 Method',
                fields: [
                    { name: 'function', label: 'Differential equation dy/dx = f(x,y)', type: 'text', placeholder: 'e.g., x + y, x**2 + y**2', required: true },
                    { name: 'x0', label: 'Initial x value', type: 'number', placeholder: 'e.g., 0', required: true },
                    { name: 'y0', label: 'Initial y value', type: 'number', placeholder: 'e.g., 1', required: true },
                    { name: 'h', label: 'Step size', type: 'number', placeholder: 'e.g., 0.1', value: '0.1', required: true },
                    { name: 'n', label: 'Number of steps', type: 'number', placeholder: 'e.g., 10', value: '10', required: true }
                ],
                example: {
                    function: 'x + y',
                    x0: '0',
                    y0: '1',
                    h: '0.1',
                    n: '10'
                },
                apiEndpoint: '/api/rk2'
            }
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            const config = methodConfigs[methodName];
            if (!config) {
                document.body.innerHTML = '<h3>Method not found</h3>';
                return;
            }

            // Generate form fields
            const formFields = document.getElementById('form-fields');
            formFields.innerHTML = '';

            config.fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'mb-3';

                const label = document.createElement('label');
                label.className = 'form-label';
                label.htmlFor = field.name;
                label.textContent = field.label;

                const input = document.createElement('input');
                input.type = field.type;
                input.className = 'form-control';
                input.id = field.name;
                input.name = field.name;
                input.placeholder = field.placeholder;
                input.required = field.required;
                // Add step attribute for decimal inputs
                if (field.name === 'tolerance' || field.name === 'h' || field.name === 'x0' || field.name === 'y0') {
                    input.step = 'any';
                }
                if (field.value) {
                    input.value = field.value;
                }

                fieldDiv.appendChild(label);
                fieldDiv.appendChild(input);
                formFields.appendChild(fieldDiv);
            });
        });

        // Handle form submission
        document.getElementById('method-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const config = methodConfigs[methodName];
            if (!config) return;

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';

            // Collect form data
            const formData = {};
            config.fields.forEach(field => {
                const element = document.getElementById(field.name);
                let value = element.value;
                
                // Handle JSON fields (matrix, b_vector, etc.)
                if (field.name === 'matrix' || field.name === 'b_vector' || 
                    field.name === 'a' || field.name === 'b' || field.name === 'c' || field.name === 'd') {
                    try {
                        value = JSON.parse(value);
                    } catch (e) {
                        showError(`Invalid JSON format for ${field.label}: ${e.message}`);
                        return;
                    }
                }
                
                // Handle x_points/y_points differently per method
                if (field.name === 'x_points' || field.name === 'y_points') {
                    try {
                        // For tabular methods, accept comma-separated lists
                        if (methodName.endsWith('_tabular')) {
                            console.log(`Processing ${field.name} (tabular): "${value}"`);
                            value = value.split(',').map(item => item.trim());
                            console.log(`After processing ${field.name} (tabular):`, value);
                        } else if (methodName.includes('interpolation')) {
                            // For interpolation, expect JSON arrays like [1,2,3]
                            console.log(`Processing ${field.name} (interpolation JSON): "${value}"`);
                            if (typeof value === 'string') {
                                value = JSON.parse(value);
                            }
                            console.log(`After processing ${field.name} (interpolation):`, value);
                        }
                    } catch (e) {
                        showError(`Invalid format for ${field.label}: ${e.message}`);
                        return;
                    }
                }
                
                formData[field.name] = value;
            });

            // Send request
            console.log('Sending request to:', config.apiEndpoint);
            console.log('Request data:', formData);
            console.log('JSON.stringify(formData):', JSON.stringify(formData));
            fetch(config.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                console.log('Response data:', data);
                
                if (data.success) {
                    displayResults(data.result, data.plot);
                } else {
                    showError(data.error || 'An error occurred');
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                console.error('Error details:', error);
                showError('Network error: ' + error.message);
            });
        });

        function displayResults(result, plotData) {
            const resultsDiv = document.getElementById('results');
            const finalResultDiv = document.getElementById('final-result');
            const methodInfoDiv = document.getElementById('method-info');
            const iterationTableDiv = document.getElementById('iteration-table');
            const plotContainerDiv = document.getElementById('plot-container');
            const config = methodConfigs[methodName];

            // Display final result
            let finalResultHTML = '';
            
            // Handle different result formats for different methods
            let rootValue = null;
            let rootLabel = '';
            
            if (result.root !== undefined) {
                rootValue = result.root;
                rootLabel = 'Root';
            } else if (result.x !== undefined) {
                rootValue = result.x;
                rootLabel = 'Root';
            } else if (result.solution !== undefined) {
                rootValue = result.solution;
                rootLabel = 'Solution';
            } else if (result.interpolated_value !== undefined) {
                rootValue = result.interpolated_value;
                rootLabel = 'Interpolated Value';
            } else if (result.integral !== undefined) {
                rootValue = result.integral;
                rootLabel = 'Integral';
            } else if (result.x_values !== undefined && result.y_values !== undefined) {
                // Handle ODE methods
                rootValue = result.y_values[result.y_values.length - 1];
                rootLabel = 'Final y value';
            }
            
            if (rootValue !== null) {
                if (Array.isArray(rootValue)) {
                    // Handle array solutions (for linear systems)
                    finalResultHTML += `<p><strong>${rootLabel}:</strong></p>`;
                    finalResultHTML += '<ul>';
                    rootValue.forEach((val, index) => {
                        finalResultHTML += `<li>x${index + 1} = ${val.toFixed(8)}</li>`;
                    });
                    finalResultHTML += '</ul>';
                } else {
                    // Handle single value solutions
                    finalResultHTML += `<p><strong>${rootLabel}:</strong> ${rootValue.toFixed(8)}</p>`;
                    
                    // Calculate and display function value at root (for root finding methods)
                    if (result.iterations && result.iterations.length > 0) {
                        const lastIteration = result.iterations[result.iterations.length - 1];
                        if (lastIteration.f_c !== undefined) {
                            finalResultHTML += `<p><strong>f(root):</strong> ${lastIteration.f_c.toFixed(8)}</p>`;
                        } else if (lastIteration.f_x !== undefined) {
                            finalResultHTML += `<p><strong>f(root):</strong> ${lastIteration.f_x.toFixed(8)}</p>`;
                        }
                    }
                }
            }
            
            finalResultHTML += `<p><strong>Iterations:</strong> ${result.final_iteration || result.iterations?.length || 0}</p>`;
            // ODE methods don't use convergence; show status instead
            if (result.x_values !== undefined && result.y_values !== undefined) {
                finalResultHTML += `<p><strong>Status:</strong> Completed</p>`;
            } else {
                finalResultHTML += `<p><strong>Converged:</strong> ${result.converged ? 'Yes' : 'No'}</p>`;
            }
            
            finalResultDiv.innerHTML = finalResultHTML;

            // Display method info
            let methodInfoHTML = `<p><strong>Method:</strong> ${result.method || (config ? config.title : methodName.replace('_', ' ').toUpperCase())}</p>`;
            
            if (result.x_values !== undefined && result.y_values !== undefined) {
                // ODE method info
                methodInfoHTML += `<p><strong>Step Size:</strong> ${result.h}</p>`;
                methodInfoHTML += `<p><strong>Number of Steps:</strong> ${result.n_steps}</p>`;
                methodInfoHTML += `<p><strong>Initial Condition:</strong> y(${result.x_values[0]}) = ${result.y_values[0]}</p>`;
                methodInfoHTML += `<p><strong>Final Value:</strong> y(${result.x_values[result.x_values.length-1]}) = ${result.y_values[result.y_values.length-1].toFixed(6)}</p>`;
            } else if (result.method && (result.method.includes('Gauss') || result.method.includes('Thomas'))) {
                // Matrix method info
                methodInfoHTML += `<p><strong>Matrix Size:</strong> ${result.matrix_size} × ${result.matrix_size}</p>`;
                methodInfoHTML += `<p><strong>Tolerance:</strong> ${result.tolerance}</p>`;
                methodInfoHTML += `<p><strong>Convergence:</strong> ${result.converged ? 'Successful' : 'Not converged'}</p>`;
                methodInfoHTML += `<p><strong>Iterations:</strong> ${result.final_iteration}</p>`;
                
                if (result.solution) {
                    methodInfoHTML += `<p><strong>Solution:</strong> [${result.solution.map(x => x.toFixed(6)).join(', ')}]</p>`;
                }
            } else {
                methodInfoHTML += `<p><strong>Convergence:</strong> ${result.converged ? 'Successful' : 'Not converged'}</p>`;
            }
            
            methodInfoDiv.innerHTML = methodInfoHTML;

            // Display iteration table or steps
            if (result.steps && result.steps.length > 0) {
                // Display detailed steps for interpolation methods
                let stepsHTML = '<div class="alert alert-info"><h5><i class="fas fa-info-circle me-2"></i>Detailed Steps</h5>';
                stepsHTML += '<div style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">';
                result.steps.forEach(step => {
                    stepsHTML += `<div style="margin-bottom: 0.5rem;">${step}</div>`;
                });
                stepsHTML += '</div></div>';
                iterationTableDiv.innerHTML = stepsHTML;
            } else if (result.iterations && result.iterations.length > 0) {
                // Enhanced table display for matrix methods
                if (result.method && (result.method.includes('Gauss') || result.method.includes('Thomas'))) {
                    // Special handling for matrix methods
                    let tableHTML = '<div class="row">';
                    
                    // Main iteration table
                    tableHTML += '<div class="col-md-8">';
                    tableHTML += '<h5><i class="fas fa-table me-2"></i>Iteration Details</h5>';
                    tableHTML += '<div class="table-responsive">';
                    tableHTML += '<table class="table table-striped table-hover table-sm">';
                    tableHTML += '<thead class="table-dark"><tr><th>Iteration</th>';
                    
                    // Determine headers based on method
                    const firstIteration = result.iterations[0];
                    const headers = Object.keys(firstIteration).filter(key => 
                        key !== 'iteration' && key !== 'residuals' && key !== 'max_residual'
                    );
                    
                    headers.forEach(header => {
                        const headerName = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        if (header === 'x_old' || header === 'x_new' || header === 'x') {
                            tableHTML += `<th>${headerName}</th>`;
                        } else {
                            tableHTML += `<th>${headerName}</th>`;
                        }
                    });
                    tableHTML += '<th>Max Error</th>';
                    if (firstIteration.max_residual !== undefined) {
                        tableHTML += '<th>Max Residual</th>';
                    }
                    tableHTML += '</tr></thead><tbody>';
                    
                    result.iterations.forEach(iteration => {
                        tableHTML += '<tr>';
                        tableHTML += `<td><strong>${iteration.iteration}</strong></td>`;
                        
                        headers.forEach(header => {
                            const value = iteration[header];
                            if (Array.isArray(value)) {
                                // Format array values (x vectors)
                                const formattedValues = value.map(v => v.toFixed(6)).join(', ');
                                tableHTML += `<td style="font-family: monospace; font-size: 0.85em;">[${formattedValues}]</td>`;
                            } else if (typeof value === 'number') {
                                if (header.includes('error') || header.includes('residual')) {
                                    tableHTML += `<td class="text-danger">${value.toFixed(8)}</td>`;
                                } else {
                                    tableHTML += `<td>${value.toFixed(6)}</td>`;
                                }
                            } else {
                                tableHTML += `<td>${value}</td>`;
                            }
                        });
                        
                        // Add max error
                        tableHTML += `<td class="text-danger"><strong>${iteration.max_error.toFixed(8)}</strong></td>`;
                        
                        // Add max residual if available
                        if (iteration.max_residual !== undefined) {
                            tableHTML += `<td class="text-warning">${iteration.max_residual.toFixed(8)}</td>`;
                        }
                        
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';
                    tableHTML += '</div></div>';
                    
                    // Residual details table
                    if (result.iterations[0].residuals) {
                        tableHTML += '<div class="col-md-4">';
                        tableHTML += '<h5><i class="fas fa-chart-line me-2"></i>Residuals (Last Iteration)</h5>';
                        tableHTML += '<div class="table-responsive">';
                        tableHTML += '<table class="table table-sm table-bordered">';
                        tableHTML += '<thead class="table-info"><tr><th>Equation</th><th>Residual</th></tr></thead><tbody>';
                        
                        const lastIteration = result.iterations[result.iterations.length - 1];
                        lastIteration.residuals.forEach((residual, index) => {
                            const rowClass = Math.abs(residual) > 0.001 ? 'table-warning' : '';
                            tableHTML += `<tr class="${rowClass}">`;
                            tableHTML += `<td>${index + 1}</td>`;
                            tableHTML += `<td class="text-end">${residual.toFixed(8)}</td>`;
                            tableHTML += '</tr>';
                        });
                        tableHTML += '</tbody></table>';
                        tableHTML += '</div></div>';
                    }
                    
                    tableHTML += '</div>';
                    iterationTableDiv.innerHTML = tableHTML;
                    
                } else {
                    // Standard table for other methods
                    const headers = Object.keys(result.iterations[0]).filter(key => key !== 'iteration');
                    let tableHTML = '<table class="table table-striped table-hover">';
                    tableHTML += '<thead><tr><th>Iteration</th>';
                    headers.forEach(header => {
                        tableHTML += `<th>${header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`;
                    });
                    tableHTML += '</tr></thead><tbody>';
                    
                    result.iterations.forEach(iteration => {
                        tableHTML += '<tr>';
                        tableHTML += `<td>${iteration.iteration}</td>`;
                        headers.forEach(header => {
                            const value = iteration[header];
                            if (typeof value === 'number') {
                                // Use more precision for tolerance-related fields
                                if (header.includes('error') || header.includes('tolerance')) {
                                    tableHTML += `<td>${value.toFixed(8)}</td>`;
                                } else {
                                    tableHTML += `<td>${value.toFixed(6)}</td>`;
                                }
                            } else {
                                tableHTML += `<td>${value}</td>`;
                            }
                        });
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';
                    iterationTableDiv.innerHTML = tableHTML;
                }
            } else if (result.x_values !== undefined && result.y_values !== undefined) {
                // Handle ODE methods - display step-by-step results
                let tableHTML = '<table class="table table-striped table-hover">';
                tableHTML += '<thead><tr><th>Step</th><th>x</th><th>y</th><th>dy/dx</th></tr></thead><tbody>';
                
                for (let i = 0; i < result.x_values.length; i++) {
                    const x = result.x_values[i];
                    const y = result.y_values[i];
                    let dy_dx = '';
                    
                    if (i < result.x_values.length - 1) {
                        // Calculate dy/dx for this step (except the last step)
                        const next_x = result.x_values[i + 1];
                        const next_y = result.y_values[i + 1];
                        dy_dx = ((next_y - y) / (next_x - x)).toFixed(6);
                    }
                    
                    tableHTML += '<tr>';
                    tableHTML += `<td>${i}</td>`;
                    tableHTML += `<td>${x.toFixed(6)}</td>`;
                    tableHTML += `<td>${y.toFixed(6)}</td>`;
                    tableHTML += `<td>${dy_dx}</td>`;
                    tableHTML += '</tr>';
                }
                tableHTML += '</tbody></table>';
                iterationTableDiv.innerHTML = tableHTML;
            } else if (result.forward_steps && result.backward_steps) {
                // Special handling for Thomas Algorithm
                let tableHTML = '<div class="row">';
                
                // Forward elimination steps
                tableHTML += '<div class="col-md-6">';
                tableHTML += '<h5><i class="fas fa-arrow-down me-2"></i>Forward Elimination</h5>';
                tableHTML += '<div class="table-responsive">';
                tableHTML += '<table class="table table-striped table-hover table-sm">';
                tableHTML += '<thead class="table-primary"><tr><th>Step</th><th>i</th><th>c_prime[i]</th><th>d_prime[i]</th></tr></thead><tbody>';
                
                result.forward_steps.forEach(step => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${step.step}</td>`;
                    tableHTML += `<td>${step.i}</td>`;
                    tableHTML += `<td style="font-family: monospace; font-size: 0.85em;">${step['c_prime[i]']}</td>`;
                    tableHTML += `<td style="font-family: monospace; font-size: 0.85em;">${step['d_prime[i]']}</td>`;
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody></table>';
                tableHTML += '</div></div>';
                
                // Backward substitution steps
                tableHTML += '<div class="col-md-6">';
                tableHTML += '<h5><i class="fas fa-arrow-up me-2"></i>Backward Substitution</h5>';
                tableHTML += '<div class="table-responsive">';
                tableHTML += '<table class="table table-striped table-hover table-sm">';
                tableHTML += '<thead class="table-success"><tr><th>Step</th><th>i</th><th>x[i]</th></tr></thead><tbody>';
                
                result.backward_steps.forEach(step => {
                    tableHTML += '<tr>';
                    tableHTML += `<td>${step.step}</td>`;
                    tableHTML += `<td>${step.i}</td>`;
                    tableHTML += `<td style="font-family: monospace; font-size: 0.85em;">${step['x[i]']}</td>`;
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody></table>';
                tableHTML += '</div></div>';
                
                tableHTML += '</div>';
                iterationTableDiv.innerHTML = tableHTML;
            } else {
                iterationTableDiv.innerHTML = '<p>No iteration data available.</p>';
            }

            // Display plot
            console.log('Plot data received:', plotData ? 'Yes' : 'No');
            if (plotData) {
                console.log('Plot data length:', plotData.length);
                console.log('Plot data preview:', plotData.substring(0, 100) + '...');
                plotContainerDiv.innerHTML = `<img src="data:image/png;base64,${plotData}" alt="Method visualization" class="img-fluid">`;
            } else {
                plotContainerDiv.innerHTML = '<p>No visualization available for this method.</p>';
            }

            resultsDiv.style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function loadExample() {
            const config = methodConfigs[methodName];
            if (!config || !config.example) return;

            Object.keys(config.example).forEach(fieldName => {
                const element = document.getElementById(fieldName);
                if (element) {
                    element.value = config.example[fieldName];
                }
            });
        }
    </script>
</body>
</html> 